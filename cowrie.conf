input {
  beats {
    port => 5044
    type => "cowrie"
  }
}

filter {
  if [type] == "cowrie" or [log_type] == "cowrie" {
    # Parse timestamp
    if [timestamp] {
      date {
        match => [ "timestamp", "ISO8601" ]
        target => "@timestamp"
      }
    }
    
    # GeoIP enrichment
    if [src_ip] {
      geoip {
        source => "src_ip"
        target => "geoip"
        fields => [
          "city_name",
          "country_name",
          "country_code2",
          "country_code3",
          "continent_code",
          "location",
          "region_name",
          "timezone"
        ]
      }
      
      geoip {
        source => "src_ip"
        target => "geoip_asn"
        default_database_type => "ASN"
      }
    }
    
    # Tag successful logins
    if [eventid] == "cowrie.login.success" {
      mutate {
        add_tag => ["authentication", "successful_login", "alert"]
      }
    }
    
    # Tag failed logins
    if [eventid] == "cowrie.login.failed" {
      mutate {
        add_tag => ["authentication", "failed_login"]
      }
    }
    
    # Tag and detect dangerous commands
    if [eventid] == "cowrie.command.input" {
      mutate {
        add_tag => ["command"]
      }
      
      if [input] =~ /wget|curl|chmod|\/bin\/sh|bash|nc|nmap|perl|python/ {
        mutate {
          add_tag => ["dangerous_command", "alert"]
        }
      }
    }
    
    # Tag session events
    if [eventid] == "cowrie.session.connect" {
      mutate {
        add_tag => ["session_start"]
      }
    }
    
    if [eventid] == "cowrie.session.closed" {
      mutate {
        add_tag => ["session_end"]
      }
    }
    
    # Tag malware downloads
    if [eventid] == "cowrie.session.file_download" {
      mutate {
        add_tag => ["malware_download", "file_download", "alert"]
      }
    }
    
    # Set daily index pattern
    mutate {
      add_field => {
        "[@metadata][index]" => "cowrie-%{+YYYY.MM.dd}"
      }
    }
    
    # Clean up unnecessary fields
    mutate {
      remove_field => ["agent", "ecs", "host", "log", "input"]
    }
  }
}

output {
  if [type] == "cowrie" or [log_type] == "cowrie" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "%{[@metadata][index]}"
      document_type => "_doc"
    }
  }
}
